<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Take Home Midterm</title>
    
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.16.0/umd/popper.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
    <script src="CSMP.json"></script>
    <script>
     const instructors = [];
     const children = []; 
     const departments =[];  
     
    
    async function myFetch() {
        let heading = document.getElementById("heading");    
        //let response = await fetch('./CSMP.json');
        let response = await fetch('./all.json')
        heading.innerText ="Data is being received"
    if (!response.ok) 
    {
        throw new Error(`HTTP error! status: ${response.status}`);
        heading.innerText ="Data Failed";
    } else {
        heading.innerText="Data Reccieved";
        let myJson = await response.json();
        for(child of myJson)
        {    
            if(!(departments.includes(child.dept)))                
            {
                departments.push(child); // build a list of departments
            }
        }
            //heading.innerText="Courses";
            buildDepartmentList();
            document.getElementById("department").style.visibility = "visible";
        }
    }

    async function fetchInstructors() {
        // First clear out instructors list if populated
        while(instructors.length > 0) 
        {
            instructors.pop();
        }
         // file name we need to fetch from chosen Department
        let departmentFile= document.getElementById("departmentList").value;
        let response = await fetch(departmentFile)
        if (!response.ok) {
        throw new Error(`HTTP error! status: ${response.status}`);
        heading.innerText ="Data Failed";
    } else {
        heading.innerText="Data Reccieved";
        let myJson = await response.json();
        for(child of myJson){
                children.push(child); // adding these courses to our list for later use 
                
                if(!(instructors.includes(child.instructor)))
                {
                    instructors.push(child.instructor); // build a list of instructors for given Department
                    
                }
            }
        buildInstructorsList();
        document.getElementById("selections").style.visibility = "visible";
        }
    }

        function buildDepartmentList(){
            let lines ="";
            let theBody = document.getElementById("departmentList");
            for(child in departments)
            {
                lines+= "<option value="+departments[child].filename+">"+departments[child].dept+"</option>";
            }
            theBody.innerHTML = lines;
        }
        function buildInstructorsList(){
            let lines = "";
            let theBody = document.getElementById("instructorslist");
            for(instructor in instructors)
            {
                // console.log(instructors[instructor]);
                lines+= "<option value="+instructors[instructor]+">"+instructors[instructor]+"</option>";
            }
            theBody.innerHTML = lines;
        }
        
        function getCoursesForInstructor(){
            let lines ="";
            courses = [];
            var e = document.getElementById("instructorslist");
            var val1 = e.options[e.selectedIndex].value;
            let selectedInstructor = e.options[e.selectedIndex].text;

            for(child in children)
            {
               // console.log(selectedInstructor);
                //console.log(children[child].instructor)
                if(children[child].hours >0)
                {
                    if(selectedInstructor==children[child].instructor)
                        {
                            courses.push(new Course(children[child].course,children[child].title,children[child].days,children[child].hours,children[child].room,children[child].times))
                        }
                }
            }
            // call a sort function
            courses.sort(function(a,b){
                var daya = a.days;
                var dayb = b.days;
                if(daya < dayb){
                    return-1;
                }
                if(daya> dayb){
                    return 1;
                }
                if(a.times.includes("AM")){
                    if(b.times.includes("PM")){
                        return -1;
                    }
                    if(a.times<b.times){
                    return -1
                    }
                    if(a.times>b.times){
                        return 1
                    }
                }
                if(a.times.includes("PM")){
                    if(b.times.includes("AM")){
                        return 1;
                    }
                if(a.times<b.times){
                    return -1
                    }
                if(a.times>b.times){
                        return 1
                    }
                return 0;
                }
            })

            for(course in courses){
                lines+= "<div class='col-1'>" + courses[course].course +"</div>"
                lines+= "<div class='col-3'>" + courses[course].title +"</div>"
                lines+= "<div class='col-1'>" + courses[course].hours +"</div>"
                lines+= "<div class='col-1'>" + courses[course].days +"</div>"
                lines+= "<div class='col-2'>" + courses[course].times +"</div>"
                lines+= "<div class='col-1'>" + courses[course].room +"</div>"
                lines+= "<div class='col-3'>" + selectedInstructor +"</div>"

                
            }
            let list = document.getElementById("course");
            list.innerHTML = lines;
        }

        function Course(course,title,days,hours,room,times){
            this.course = course;
            this.title = title;
            this.days = days;
            this.hours = hours;
            this.room = room;
            this.times = times;
            this.print = function(){
                return this.course + " " + this.title + " reports on " + this.days + " at " + this.times +" for "+this.hours +"hours in " + this.room;
            }
        }
        function main()
        {   
            // Hidden Lists
            document.getElementById("selections").style.visibility = "hidden";
    
            myFetch()
            .catch(e => {
            console.log('There has been a problem with your department fetch operation: ' + e.message);
        });        
        }
    </script>
</head>

<body onload="main()">   
    
    <h1 id =heading>Missouri Western State University Catalog</h1>
    <div id="selections">
    <div class="col-sm" id="department">
    <label for="departments">Choose a Department:</label>
    <select name="departments" id="departmentList" onchange="fetchInstructors()"></select>
    </div>
    <div class="col-sm" id="instructors">
    <label for="instructors">Choose a instructor:</label>
    <select name="instructors" id="instructorslist" onchange="getCoursesForInstructor()"></select>
    </div>
    </div>

   

      
    <div class="container">
        <div class="row" id="header">
            <div class="col-1">Course</div>
            <div class="col-3">Title</div>
            <div class="col-1">Hrs</div>
            <div class="col-1">Days</div>
            <div class="col-2">Times</div>
            <div class="col-1">Room</div>
            <div class="col-3">Instructor</div>
        </div>
        <div class="row" id="course">

        </div>

      </div>

</body>
</html>